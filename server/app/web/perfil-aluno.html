<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/aluno/perfilAluno.css">

    <title>eClasses</title>
</head>

<body>
    <header class="bg-primary">
        <div class="container">
            <div class="row">
                <div class="col-11">
                    <h2>eClasses</h2>
                </div>
            </div>
        </div>
    </header>

    <main id="altered-main">
        <div class="container">
            <div class="row">
                <div class="card col-12 col-md-6">
                    <h3 id="nome" class="card-header bg-primary text-white">

                    </h3>
                    <div class="card-body">
                        <dl id="listaDados" class="row">
                            <dt class="col-6">E-mail</dt>
                            <dd class="col-6" id="email"></dd>
                            <dt class="col-6">UF</dt>
                            <dd class="col-6" id="uf"></dd>
                            <dt class="col-6">Município</dt>
                            <dd class="col-6" id="municipio"></dd>
                            <dt class="col-6">Assinante</dt>
                            <dd class="col-6" id="assinante"></dd>
                        </dl>
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <a class="btn btn-secondary col-12 col-md-3" onclick="alert('Edição Perfil')">Editar
                                perfil</a>
                            <a class="btn btn-outline-danger col-12 col-md-3 ml-auto"
                                onclick="alert('Alterar senha')">Alterar senha</a>
                        </div>
                    </div>
                </div>

                <div class="card col-12 col-md-5 offset-md-1">
                    <h3 class="card-header bg-dark text-white">
                        Preferências
                    </h3>
                    <div class="card-body">
                        <dl id="listaPreferencias" class="row">
                            <dt class="col-6">Preço limite</dt>
                            <dd class="col-6" id="preco">R$ </dd>
                            <dt class="col-6">Localidade</dt>
                            <dd class="col-6" id="local"></dd>
                            <dt class="col-6">Nº máximo de alunos</dt>
                            <dd class="col-6" id="numero-alunos"></dd>
                            <dt class="col-12 center">Materias</dt>
                        </dl>
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <a class="btn btn-secondary col-12 col-md-5" onclick="alert('Edição Preferências')">Editar
                                preferências</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">

            </div>
        </div>
    </main>

    <footer class="bg-secondary fixed-bottom">
        <div class="container">
            <div class="row">
                <div class="col">
                    <b>Desenvolvido por:</b>
                    <p>Matheus Guimarães | Pedro Augusto Gandra | Pedro Henrique Pereira | Samuel Pedro Fernandes |
                        Thiago Lepesqueur | Vitor Fitzherbert</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
      let listaDados = document.querySelector("#listaDados");
      let listaPreferencias = document.querySelector("#listaPreferencias");
      let idAluno;

      let campoNome = document.querySelector("#nome");
      let campoEmail = document.querySelector("#email");
      let campoUf = document.querySelector("#uf");
      let campoMunicipio = document.querySelector("#municipio");
      let campoAssinante = document.querySelector("#assinante");

      let campoPreco = document.querySelector("#preco");
      let campoLocalidade = document.querySelector("#local");
      let campoNumeroAlunos = document.querySelector("#numero-alunos");

      function consultarLogado() {

        let url = "http://localhost:8080/app/consultar/logado";
        fetch(url, { method: "POST", credentials: 'include' })
          .then(resposta => resposta.arrayBuffer())
          .then(buffer => {
            let decoder = new TextDecoder("iso-8859-1");
            let text = decoder.decode(buffer);
            parser = new DOMParser();
            xmlDoc = parser.parseFromString(text, "text/xml");
            var cargo = xmlDoc.getElementsByTagName("usuario")[0].getElementsByTagName("cargo")[0].childNodes[0].nodeValue;
            idAluno = xmlDoc.getElementsByTagName("usuario")[0].getElementsByTagName("id")[0].childNodes[0].nodeValue;

            if (cargo != "ALUNO") {
              location.href = "login.html";
            } else {

              url = "http://localhost:8080/app/aluno/consultar?id="+idAluno;
              fetch(url, { method: "POST", credentials: 'include' })
                .then(resposta => resposta.arrayBuffer())
                .then(buffer => {
                  let decoder = new TextDecoder("iso-8859-1");
                  let text = decoder.decode(buffer);
                  parser = new DOMParser();
                  xmlDoc = parser.parseFromString(text, "text/xml");
                  var aluno = xmlDoc.getElementsByTagName("aluno")[0];
                  campoNome.innerHTML = aluno.getElementsByTagName("nome")[0].childNodes[0].nodeValue;
                  campoEmail.innerHTML = aluno.getElementsByTagName("email")[0].childNodes[0].nodeValue;
                  if (aluno.getElementsByTagName("assinante")[0].childNodes[0].nodeValue == "true") {
                    campoAssinante.innerHTML = "Sim";
                    let dt = document.createElement("dt");
                    dt.classList.add("col-6");
                    dt.innerHTML = "Data do fim da assinatura";
                    listaDados.appendChild(dt);
                    let dd = document.createElement("dd");
                    dd.classList.add("col-6");
                    dd.innerHTML = conversionData1(aluno.getElementsByTagName("data-fim-assinatura")[0].childNodes[0].nodeValue);
                    listaDados.appendChild(dd);
                  } else
                    campoAssinante.innerHTML = "Não";
                  let idUf = aluno.getElementsByTagName("id-uf")[0].childNodes[0].nodeValue;
                  let idMunicipio = aluno.getElementsByTagName("id-municipio")[0].childNodes[0].nodeValue;

                  url = "http://localhost:8080/app/consultar/uf?id="+idUf;
                  fetch(url, { method: "POST", credentials: 'include' })
                    .then(resposta => resposta.arrayBuffer())
                    .then(buffer => {
                      let decoder = new TextDecoder("iso-8859-1");
                      let text = decoder.decode(buffer);
                      parser = new DOMParser();
                      xmlDoc = parser.parseFromString(text, "text/xml");
                      campoUf.innerHTML = xmlDoc.getElementsByTagName("uf")[0].getElementsByTagName("sigla")[0].childNodes[0].nodeValue;
                  });

                  url = "http://localhost:8080/app/consultar/municipio?id="+idMunicipio;
                  fetch(url, { method: "POST", credentials: 'include' })
                    .then(resposta => resposta.arrayBuffer())
                    .then(buffer => {
                      let decoder = new TextDecoder("iso-8859-1");
                      let text = decoder.decode(buffer);
                      parser = new DOMParser();
                      xmlDoc = parser.parseFromString(text, "text/xml");
                      campoMunicipio.innerHTML = xmlDoc.getElementsByTagName("municipio")[0].getElementsByTagName("nome")[0].childNodes[0].nodeValue;
                  });

                  let preco = aluno.getElementsByTagName("preferencia-preco")[0].childNodes[0].nodeValue;
                  let precoParsed = parseFloat(preco);
                  precoParsed = precoParsed.toFixed(2);
                  campoPreco.innerHTML += convertComma(precoParsed.toString());
                  campoNumeroAlunos.innerHTML = aluno.getElementsByTagName("preferencia-numero-alunos")[0].childNodes[0].nodeValue;

                  let idPrefLocal = aluno.getElementsByTagName("id-preferencia-local")[0].childNodes[0].nodeValue;
                  url = "http://localhost:8080/app/consultar/preferencialocal?id="+idPrefLocal;
                  fetch(url, { method: "POST", credentials: 'include' })
                    .then(resposta => resposta.arrayBuffer())
                    .then(buffer => {
                      let decoder = new TextDecoder("iso-8859-1");
                      let text = decoder.decode(buffer);
                      parser = new DOMParser();
                      xmlDoc = parser.parseFromString(text, "text/xml");
                      campoLocalidade.innerHTML = xmlDoc.getElementsByTagName("preferencia-localizacao")[0].getElementsByTagName("descricao")[0].childNodes[0].nodeValue;
                  });

                  let lineMaterias = aluno.getElementsByTagName("id-materia");
                  for (let i = 0; i < lineMaterias.length; i++) {
                    let nomeMateria;

                    url = "http://localhost:8080/app/consultar/materia?id="+lineMaterias[i].childNodes[0].nodeValue;
                    fetch(url, { method: "POST", credentials: 'include' })
                      .then(resposta => resposta.arrayBuffer())
                      .then(buffer => {
                        let decoder = new TextDecoder("iso-8859-1");
                        let text = decoder.decode(buffer);
                        parser = new DOMParser();
                        xmlDoc = parser.parseFromString(text, "text/xml");
                        nomeMateria = xmlDoc.getElementsByTagName("materia")[0].getElementsByTagName("nome")[0].childNodes[0].nodeValue;
                        let dd = document.createElement("dd");
                        dd.classList.add("col-12");
                        dd.classList.add("materias");
                        dd.innerHTML = nomeMateria;
                        listaPreferencias.appendChild(dd);
                    });
                  }

                });
            }
        });
      }

      window.onload = function() {
        consultarLogado();
      };

    </script>
    <script src="js/utils/convertions.js"></script>
    <script src="js/preencherLocais.js"></script>
    <script src="js/carregarLocais.js"></script>
    <script src="lib/jquery/jquery-3.5.1.min.js"></script>
    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>


</body>

</html>
